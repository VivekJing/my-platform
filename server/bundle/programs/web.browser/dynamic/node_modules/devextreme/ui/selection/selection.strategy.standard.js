function module(e,t,s){"use strict";var i=e("../../core/utils/common"),n=e("../../core/utils/type"),o=i.getKeyHash,l=e("../../data/query"),h=e("../../core/utils/deferred"),c=e("../../core/utils/selection_filter").SelectionFilterCreator,d=h.when,r=h.Deferred,a=e("../widget/ui.errors"),p=e("./selection.strategy");s.exports=p.inherit({ctor:function(e){this.callBase(e),this._initSelectedItemKeyHash()},_initSelectedItemKeyHash:function(){this._setOption("keyHashIndices",this.options.equalByReference?null:{})},getSelectedItemKeys:function(){return this.options.selectedItemKeys.slice(0)},getSelectedItems:function(){return this.options.selectedItems.slice(0)},_preserveSelectionUpdate:function(e,t){var s,i,n,o=this.options.keyOf;if(o){var l=t&&e.length>1&&!this.options.equalByReference;for(l&&(s={}),n=0;n<e.length;n++){var h=e[n],c=o(h);t?(i=this.removeSelectedItem(c,s),s&&i>=0&&(s[i]=!0)):this.addSelectedItem(c,h)}l&&this._batchRemoveSelectedItems(s)}},_batchRemoveSelectedItems:function(e){var t=this.options.selectedItemKeys.slice(0),s=this.options.selectedItems.slice(0);this.options.selectedItemKeys.length=0,this.options.selectedItems.length=0;for(var i=0;i<t.length;i++)e[i]||(this.options.selectedItemKeys.push(t[i]),this.options.selectedItems.push(s[i]));this._initSelectedItemKeyHash(),this.updateSelectedItemKeyHash(this.options.selectedItemKeys)},_loadSelectedItemsCore:function(e,t,s){var i=new r,n=this.options.key();if(!e.length&&!s)return i.resolve([]),i;var o=this.options.filter();if(s&&t&&!o)return i.resolve(this.getSelectedItems()),i;var h=new c(e,s),d=h.getCombinedFilter(n,o),a=[];t&&(a=d?l(this.options.selectedItems).filter(d).toArray():this.options.selectedItems.slice(0));var p=a.length?a:this.options.plainItems(!0).filter(this.options.isSelectableItem).map(this.options.getItemData),m=h.getLocalFilter(this.options.keyOf,this.equalKeys.bind(this),this.options.equalByReference,n);return p=p.filter(m),a.length||!s&&p.length===e.length?i.resolve(p):i=this._loadFilteredData(d,m),i},_replaceSelectionUpdate:function(e){var t=[],s=this.options.keyOf;if(s){for(var i=0;i<e.length;i++){var n,o=s(e[i]);t.push(o)}this.setSelectedItems(t,e)}},_warnOnIncorrectKeys:function(e){for(var t=0;t<e.length;t++)this.isItemKeySelected(e[t])||a.log("W1002",e[t])},_loadSelectedItems:function(e,t,s){var i=this,n=new r;return d(i._lastLoadDeferred).always((function(){i._loadSelectedItemsCore(e,t,s).done(n.resolve).fail(n.reject)})),i._lastLoadDeferred=n,n},selectedItemKeys:function(e,t,s,i){var n=this,o=n._loadSelectedItems(e,s,i);return o.done((function(e){t?n._preserveSelectionUpdate(e,s):n._replaceSelectionUpdate(e),n.onSelectionChanged()})),o},addSelectedItem:function(e,t){var s=this._getKeyHash(e);-1===this._indexOfSelectedItemKey(s)&&(!n.isObject(s)&&this.options.keyHashIndices&&(this.options.keyHashIndices[s]=[this.options.selectedItemKeys.length]),this.options.selectedItemKeys.push(e),this.options.addedItemKeys.push(e),this.options.addedItems.push(t),this.options.selectedItems.push(t))},_getSelectedIndexByKey:function(e,t){for(var s=this.options.selectedItemKeys,i=0;i<s.length;i++)if((!t||!t[i])&&this.equalKeys(s[i],e))return i;return-1},_getSelectedIndexByHash:function(e,t){var s=this.options.keyHashIndices[e];return s&&s.length>1&&t&&(s=s.filter((function(e){return!t[e]}))),s&&s[0]>=0?s[0]:-1},_indexOfSelectedItemKey:function(e,t){var s;return s=this.options.equalByReference?this.options.selectedItemKeys.indexOf(e):n.isObject(e)?this._getSelectedIndexByKey(e,t):this._getSelectedIndexByHash(e,t)},_shiftSelectedKeyIndices:function(e){for(var t=e;t<this.options.selectedItemKeys.length;t++){var s=this.options.selectedItemKeys[t],i=o(s),n=this.options.keyHashIndices[i];if(n)for(var l=0;l<n.length;l++)n[l]>e&&n[l]--}},removeSelectedItem:function(e,t){var s=this._getKeyHash(e),i=!!t,o=this._indexOfSelectedItemKey(s,t);if(o<0)return o;if(this.options.removedItemKeys.push(e),this.options.removedItems.push(this.options.selectedItems[o]),i)return o;if(this.options.selectedItemKeys.splice(o,1),this.options.selectedItems.splice(o,1),n.isObject(s)||!this.options.keyHashIndices)return o;var l=this.options.keyHashIndices[s];return l?(l.shift(),l.length||delete this.options.keyHashIndices[s],this._shiftSelectedKeyIndices(o),o):o},_updateAddedItemKeys:function(e,t){for(var s=0;s<e.length;s++)this.isItemKeySelected(e[s])||(this.options.addedItemKeys.push(e[s]),this.options.addedItems.push(t[s]))},_updateRemovedItemKeys:function(e,t,s){for(var i=0;i<t.length;i++)this.isItemKeySelected(t[i])||(this.options.removedItemKeys.push(t[i]),this.options.removedItems.push(s[i]))},_getKeyHash:function(e){return this.options.equalByReference?e:o(e)},setSelectedItems:function(e,t){this._updateAddedItemKeys(e,t);var s=this.options.selectedItemKeys,i=this.options.selectedItems;this.options.equalByReference||(this._initSelectedItemKeyHash(),this.updateSelectedItemKeyHash(e)),this._setOption("selectedItemKeys",e),this._setOption("selectedItems",t),this._updateRemovedItemKeys(e,s,i)},isItemDataSelected:function(e){var t=this.options.keyOf(e);return this.isItemKeySelected(t)},isItemKeySelected:function(e){var t=this._getKeyHash(e),s;return-1!==this._indexOfSelectedItemKey(t)},getSelectAllState:function(e){return e?this._getVisibleSelectAllState():this._getFullSelectAllState()}})}

