function module(e,t,i){"use strict";var r=e("../../core/utils/type"),n=e("./selection.strategy"),l=e("../widget/ui.errors"),s=e("../../data/query"),o=e("../../core/utils/deferred").Deferred;i.exports=n.inherit({getSelectedItems:function(){return this._loadFilteredData(this.options.selectionFilter)},getSelectedItemKeys:function(){var e=new o,t=this,i=this.options.key(),n=r.isString(i)?[i]:i;return this._loadFilteredData(this.options.selectionFilter,null,n).done((function(i){var r=i.map((function(e){return t.options.keyOf(e)}));e.resolve(r)})).fail(e.reject),e.promise()},selectedItemKeys:function(e,t,i,r){if(r){var n=this.options.filter();n?this._addSelectionFilter(i,n,r):this._setOption("selectionFilter",i?[]:null)}else{t||this._setOption("selectionFilter",[]);for(var l=0;l<e.length;l++)i?this.removeSelectedItem(e[l]):this.addSelectedItem(e[l])}return this.onSelectionChanged(),(new o).resolve()},setSelectedItems:function(e){this._setOption("selectionFilter",null);for(var t=0;t<e.length;t++)this.addSelectedItem(e[t])},isItemDataSelected:function(e){return this.isItemKeySelected(e)},isItemKeySelected:function(e){var t=this.options.selectionFilter;return!t||!!s([e]).filter(t).toArray().length},_processSelectedItem:function(e){var t=this.options.key(),i=[t,"=",e];if(Array.isArray(t)){i=[];for(var r=0;r<t.length;r++)i.push([t[r],"=",e[t[r]]]),r!==t.length-1&&i.push("and")}return i},addSelectedItem:function(e){var t=this._processSelectedItem(e);this._addSelectionFilter(!1,t)},removeSelectedItem:function(e){var t=this._processSelectedItem(e);this._addSelectionFilter(!0,t)},validate:function(){var e=this.options.key;if(e&&void 0===e())throw l.Error("E1042","Deferred selection")},_findSubFilter:function(e,t){if(!e)return-1;for(var i=JSON.stringify(t),r=0;r<e.length;r++){var n=e[r];if(n&&JSON.stringify(n)===i)return r}return-1},_isLastSubFilter:function(e,t){return!(!e||!t)&&(this._findSubFilter(e,t)===e.length-1||0===this._findSubFilter([e],t))},_addFilterOperator:function(e,t){return e.length>1&&r.isString(e[1])&&e[1]!==t&&(e=[e]),e.length&&e.push(t),e},_denormalizeFilter:function(e){return e&&r.isString(e[0])&&(e=[e]),e},_addSelectionFilter:function(e,t,i){var r=this,n=!0,l=e?["!",t]:t,s=e?"and":"or",o=this.options.selectionFilter||[];if((o=this._denormalizeFilter(o))&&o.length){this._removeSameFilter(o,t,e,i);var a=this._removeSameFilter(o,t,!e);a&&("or"!==a&&e||"and"!==a&&!e)&&(n=!1,o=[]),n&&(o=this._addFilterOperator(o,s))}n&&o.push(l),o=this._normalizeFilter(o),this._setOption("selectionFilter",e||o.length?o:null)},_normalizeFilter:function(e){return e&&1===e.length&&(e=e[0]),e},_removeFilterByIndex:function(e,t,i){var r;return r=t>0?e.splice(t-1,2)[0]:e.splice(t,2)[1]||"undefined",i&&"and"===r&&e.splice(0,e.length),r},_removeSameFilter:function(e,t,i,r){t=i?["!",t]:t;var n=this._findSubFilter(e,t);if(JSON.stringify(t)===JSON.stringify(e))return e.splice(0,e.length),"undefined";if(n>=0)return this._removeFilterByIndex(e,n,r);for(var l=0;l<e.length;l++){var s=Array.isArray(e[l])&&e[l].length>2&&this._removeSameFilter(e[l],t,!1,r);if(s)return e[l].length?1===e[l].length&&(e[l]=e[l][0]):this._removeFilterByIndex(e,l,r),s}},getSelectAllState:function(){var e=this.options.filter(),t=this.options.selectionFilter;return!t||!!t.length&&(e&&e.length?(t=this._denormalizeFilter(t),!!this._isLastSubFilter(t,e)||!this._isLastSubFilter(t,["!",e])&&void 0):void 0)}})}

