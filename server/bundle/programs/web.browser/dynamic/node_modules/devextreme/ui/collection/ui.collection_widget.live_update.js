function module(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var i,n=_(e("../../core/renderer")),s,a=_(e("./ui.collection_widget.edit")),r=e("../../core/utils/extend"),o=e("../../core/utils/type"),d,h=_(e("../../data/array_utils")),c=e("../../data/utils"),l=e("../../core/utils/deferred"),u=e("../../core/utils/array_compare"),f=e("../../core/dom_adapter");function _(e){return e&&e.__esModule?e:{default:e}}t.default=a.default.inherit({_getDefaultOptions:function(){return(0,r.extend)(this.callBase(),{repaintChangesOnly:!1})},ctor:function(){var e=this;this.callBase.apply(this,arguments),this._customizeStoreLoadOptions=function(t){var i=e._dataSource;i&&!i.isLoaded()&&(e._correctionIndex=0),e._correctionIndex&&t.storeLoadOptions&&(t.storeLoadOptions.skip+=e._correctionIndex)},this._dataSource&&this._dataSource.on("customizeStoreLoadOptions",this._customizeStoreLoadOptions)},reload:function(){this._correctionIndex=0},_init:function(){this.callBase(),this._refreshItemsCache(),this._correctionIndex=0},_findItemElementByKey:function(e){var t=this,i=(0,n.default)(),s=this.key();return this.itemElements().each((function(a,r){var o=(0,n.default)(r),d=t._getItemData(o);if(s?(0,c.keysEqual)(s,t.keyOf(d),e):t._isItemEquals(d,e))return i=o,!1})),i},_dataSourceChangedHandler:function(e,t){t&&t.changes?this._modifyByChanges(t.changes):this.callBase(e,t)},_isItemEquals:function(e,t){try{return JSON.stringify(e)===JSON.stringify(t)}catch(i){return e===t}},_partialRefresh:function(){if(this.option("repaintChangesOnly")){var e=(0,u.findChanges)(this._itemsCache,this._editStrategy.itemsGetter(),this.keyOf.bind(this),this._isItemEquals);if(e&&this._itemsCache.length)return this._modifyByChanges(e,!0),this._renderEmptyMessage(),!0;this._refreshItemsCache()}return!1},_refreshItemsCache:function(){if(this.option("repaintChangesOnly"))try{this._itemsCache=(0,r.extend)(!0,[],this._editStrategy.itemsGetter())}catch(e){this._itemsCache=(0,r.extend)([],this._editStrategy.itemsGetter())}},_dispose:function(){this._dataSource&&this._dataSource.off("customizeStoreLoadOptions",this._customizeStoreLoadOptions),this.callBase()},_updateByChange:function(e,t,i,n){var s=this;if(n)this._renderItem(i.index,i.data,null,this._findItemElementByKey(i.key));else{var a=t[h.default.indexByKey(e,t,i.key)];a&&h.default.update(e,t,i.key,i.data).done((function(){s._renderItem(t.indexOf(a),a,null,s._findItemElementByKey(i.key))}))}},_insertByChange:function(e,t,i,n){var s=this;(0,l.when)(n||h.default.insert(e,t,i.data,i.index)).done((function(){s._beforeItemElementInserted(i),s._renderItem((0,o.isDefined)(i.index)?i.index:t.length,i.data),s._correctionIndex++}))},_updateSelectionAfterRemoveByChange:function(e){var t=this.option("selectedIndex");t>e?this.option("selectedIndex",t-1):t===e&&1===this.option("selectedItems").length?this.option("selectedItems",[]):this._normalizeSelectedItems()},_beforeItemElementInserted:function(e){var t=this.option("selectedIndex");e.index<=t&&this.option("selectedIndex",t+1)},_removeByChange:function(e,t,i,n){var s=this,a=n?i.index:h.default.indexByKey(e,t,i.key),r;if(n?i.oldItem:t[a]){var o=this._findItemElementByKey(i.key),d=this._extendActionArgs(o);this._waitDeletingPrepare(o).done((function(){n?(s._updateIndicesAfterIndex(a-1),s._afterItemElementDeleted(o,d),s._updateSelectionAfterRemoveByChange(a)):(s._deleteItemElementByIndex(a),s._afterItemElementDeleted(o,d))})),this._correctionIndex--}},_modifyByChanges:function(e,t){var i=this,n=this._editStrategy.itemsGetter(),s={key:this.key.bind(this),keyOf:this.keyOf.bind(this)},a=this._dataSource,r=a&&a.paginate(),o=a&&a.group();(r||o)&&(e=e.filter((function(e){return"insert"!==e.type||void 0!==e.index}))),e.forEach((function(e){return i["_"+e.type+"ByChange"](s,n,e,t)})),this._renderedItemsCount=n.length,this._refreshItemsCache(),this._fireContentReadyAction()},_appendItemToContainer:function(e,t,i){var n=e.children(this._itemSelector()).get(i);(0,f.insertElement)(e.get(0),t.get(0),n)},_optionChanged:function(e){switch(e.name){case"items":var t;this._partialRefresh(e.value)||this.callBase(e);break;case"dataSource":this.option("repaintChangesOnly")&&e.value||this.option("items",[]),this.callBase(e);break;case"repaintChangesOnly":break;default:this.callBase(e)}}})}

