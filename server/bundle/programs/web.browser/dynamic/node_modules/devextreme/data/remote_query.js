function module(r,e,t){"use strict";var n=r("./query_adapters"),a=r("./errors"),i=r("../core/utils/iterator").each,o=r("../core/utils/type").isFunction,u=r("../core/utils/deferred").Deferred,c=r("./array_query"),s=function r(e,t,s){s=s||[],t=t||{};var f=function(r,e){return{name:r,args:e}},l=function(r){var l,h,g,m,y,p=new u,d=function(r){var e=t.errorHandler;e&&e(r),a._errorHandler(r),p.reject(r)};function v(r){switch(r.name){case"sortBy":return y=[r.args],!0;case"thenBy":if(!y)throw a.errors.Error("E4004");return y.push(r.args),!0}return!1}function B(){var r=g[0],e=[];r&&"multiSort"===r.name&&(g.shift(),i(r.args[0],(function(){e.push(f(e.length?"thenBy":"sortBy",this))}))),g=e.concat(g)}try{l=t.adapter,o(l)||(l=n[l]),h=l(t),g=[].concat(s).concat(r);var S=h.optimize;for(S&&S(g);g.length;){if(!v(m=g[0])){if(y){g.unshift(f("multiSort",[y])),y=null;continue}if("enumerate"!==String(m.name)&&(!h[m.name]||!1===h[m.name].apply(h,m.args)))break}g.shift()}B(),h.exec(e).done((function(r,e){if(g.length){var n=c(r,{errorHandler:t.errorHandler});i(g,(function(){n=n[this.name].apply(n,this.args)})),n.done(p.resolve).fail(p.reject)}else p.resolve(r,e)})).fail(d)}catch(H){d(H)}return p.promise()},h={};return i(["sortBy","thenBy","filter","slice","select","groupBy"],(function(){var n=String(this);h[n]=function(){return r(e,t,s.concat(f(n,arguments)))}})),i(["count","min","max","sum","avg","aggregate","enumerate"],(function(){var r=String(this);h[r]=function(){return l.call(this,f(r,arguments))}})),h};t.exports=s}

