function module(t,e){"use strict";var i=t("../../core/class"),n=t("../../core/utils/extend").extend,a=t("../../core/utils/common"),r=t("../../core/utils/iterator"),s=t("../../core/utils/ajax"),o=t("../../core/utils/type"),u=t("../utils"),h=t("../array_utils"),c=t("../abstract_store"),d=t("../array_store"),l=t("../custom_store"),p=t("../../core/events_mixin"),_=t("../errors").errors,f=t("../../core/utils/array"),g=t("../../core/utils/queue"),y=t("../../core/utils/deferred"),L=y.when,m=y.Deferred,v=o.isString,C=o.isNumeric,O=o.isBoolean,S=o.isDefined,x="canceled";function P(){this._counter=-1,this._deferreds={}}function A(t){return"pending"===t.state()}function k(t,e){var i;function a(){var e={};return r.each(["useDefaultSearch","key","load","loadMode","cacheRawData","byKey","lookup","totalCount","insert","update","remove"],(function(){e[this]=t[this],delete t[this]})),new l(e)}function u(t){var e=t.type;return delete t.type,c.create(e,t)}function h(t){return new l({load:function(){return s.sendRequest({url:t,dataType:"json"})},loadMode:e&&e.fromUrlLoadMode})}return"string"==typeof t&&(t={paginate:!1,store:h(t)}),void 0===t&&(t=[]),void 0===(t=Array.isArray(t)||t instanceof c?{store:t}:n({},t)).store&&(t.store=[]),i=t.store,"load"in t?i=a():Array.isArray(i)?i=new d(i):o.isPlainObject(i)&&(i=u(n({},i))),t.store=i,t}function b(t){switch(t.length){case 0:return;case 1:return t[0]}return[].slice.call(t)}function E(t){return function(){var e=b(arguments);if(void 0===e)return this._storeLoadOptions[t];this._storeLoadOptions[t]=e}}function F(t,e,i){function n(t,i){return Array.isArray(t)?i?a(t,i):r.map(t,e):t}function a(t,e){return r.map(t,(function(t){var i={key:t.key,items:n(t.items,e-1)};return"aggregates"in t&&(i.aggregates=t.aggregates),i}))}return n(t,i?u.normalizeSortingInfo(i).length:0)}function I(t,e){return t&&!Array.isArray(t)&&t.data&&(e=t,t=t.data),Array.isArray(t)||(t=[t]),{data:t,extra:e}}P.prototype.constructor=P,P.prototype.add=function(t){return this._counter+=1,this._deferreds[this._counter]=t,this._counter},P.prototype.remove=function(t){return delete this._deferreds[t]},P.prototype.cancel=function(t){return t in this._deferreds&&(this._deferreds[t].reject("canceled"),!0)},P.prototype.cancelAll=function(){for(;this._counter>-1;)this.cancel(this._counter),this._counter--};var z=i.inherit({ctor:function(t){var e=this,i=this,n=0!==(t=k(t)).pushAggregationTimeout?u.throttleChanges(this._onPush,(function(){return void 0===t.pushAggregationTimeout?5*i._changedTime:t.pushAggregationTimeout})):this._onPush;this._changedTime=0,this._onPushHandler=function(t){e._aggregationTimeoutId=n.call(e,t)},this._store=t.store,this._store.on("push",this._onPushHandler),this._storeLoadOptions=this._extractLoadOptions(t),this._mapFunc=t.map,this._postProcessFunc=t.postProcess,this._pageIndex=void 0!==t.pageIndex?t.pageIndex:0,this._pageSize=void 0!==t.pageSize?t.pageSize:20,this._loadingCount=0,this._loadQueue=this._createLoadQueue(),this._searchValue="searchValue"in t?t.searchValue:null,this._searchOperation=t.searchOperation||"contains",this._searchExpr=t.searchExpr,this._paginate=t.paginate,this._reshapeOnPush=!!S(t.reshapeOnPush)&&t.reshapeOnPush,r.each(["onChanged","onLoadError","onLoadingChanged","onCustomizeLoadResult","onCustomizeStoreLoadOptions"],(function(e,n){n in t&&i.on(n.substr(2,1).toLowerCase()+n.substr(3),t[n])})),this._operationManager=new P,this._init()},_init:function(){this._items=[],this._userData={},this._totalCount=-1,this._isLoaded=!1,S(this._paginate)||(this._paginate=!this.group()),this._isLastPage=!this._paginate},dispose:function(){this._store.off("push",this._onPushHandler),this._disposeEvents(),clearTimeout(this._aggregationTimeoutId),delete this._store,this._delayedLoadTask&&this._delayedLoadTask.abort(),this._operationManager.cancelAll(),this._disposed=!0},_extractLoadOptions:function(t){var e={},i=["sort","filter","select","group","requireTotalCount"],n=this._store._customLoadOptions();return n&&(i=i.concat(n)),r.each(i,(function(){e[this]=t[this]})),e},loadOptions:function(){return this._storeLoadOptions},items:function(){return this._items},pageIndex:function(t){if(!C(t))return this._pageIndex;this._pageIndex=t,this._isLastPage=!this._paginate},paginate:function(t){if(!O(t))return this._paginate;this._paginate!==t&&(this._paginate=t,this.pageIndex(0))},pageSize:function(t){if(!C(t))return this._pageSize;this._pageSize=t},isLastPage:function(){return this._isLastPage},sort:E("sort"),filter:function(){var t=b(arguments);if(void 0===t)return this._storeLoadOptions.filter;this._storeLoadOptions.filter=t,this.pageIndex(0)},group:E("group"),select:E("select"),requireTotalCount:function(t){if(!O(t))return this._storeLoadOptions.requireTotalCount;this._storeLoadOptions.requireTotalCount=t},searchValue:function(t){if(arguments.length<1)return this._searchValue;this._searchValue=t,this.pageIndex(0)},searchOperation:function(t){if(!v(t))return this._searchOperation;this._searchOperation=t,this.pageIndex(0)},searchExpr:function(t){var e=arguments.length;if(0===e)return this._searchExpr;e>1&&(t=[].slice.call(arguments)),this._searchExpr=t,this.pageIndex(0)},store:function(){return this._store},key:function(){return this._store&&this._store.key()},totalCount:function(){return this._totalCount},isLoaded:function(){return this._isLoaded},isLoading:function(){return this._loadingCount>0},beginLoading:function(){this._changeLoadingCount(1)},endLoading:function(){this._changeLoadingCount(-1)},_createLoadQueue:function(){return g.create()},_changeLoadingCount:function(t){var e,i=this.isLoading();this._loadingCount+=t,i^(e=this.isLoading())&&this.fireEvent("loadingChanged",[e])},_scheduleLoadCallbacks:function(t){var e=this;e.beginLoading(),t.always((function(){e.endLoading()}))},_scheduleFailCallbacks:function(t){var e=this;t.fail((function(){"canceled"!==arguments[0]&&e.fireEvent("loadError",arguments)}))},_fireChanged:function(t){var e=new Date;this.fireEvent("changed",t),this._changedTime=new Date-e},_scheduleChangedCallbacks:function(t){var e=this;t.done((function(){e._fireChanged()}))},loadSingle:function(t,e){var i=this,n=new m,a=this.key(),r=this._store,s=this._createStoreLoadOptions(),o=function(t){!S(t)||f.isEmpty(t)?n.reject(new _.Error("E4009")):(Array.isArray(t)||(t=[t]),n.resolve(i._applyMapFunction(t)[0]))};function u(){return r instanceof l&&!r._byKeyViaLoad()}return this._scheduleFailCallbacks(n),arguments.length<2&&(e=t,t=a),delete s.skip,delete s.group,delete s.refresh,delete s.pageIndex,delete s.searchString,(t===a||u()?r.byKey(e,s):(s.take=1,s.filter=s.filter?[s.filter,[t,e]]:[t,e],r.load(s))).fail(n.reject).done(o),n.promise()},load:function(){var t,e=this,i=new m;function n(){if(!e._disposed&&A(i))return e._loadFromStore(t,i)}return this._scheduleLoadCallbacks(i),this._scheduleFailCallbacks(i),this._scheduleChangedCallbacks(i),t=this._createLoadOperation(i),this.fireEvent("customizeStoreLoadOptions",[t]),this._loadQueue.add((function(){return"number"==typeof t.delay?e._delayedLoadTask=a.executeAsync(n,t.delay):n(),i.promise()})),i.promise({operationId:t.operationId})},_onPush:function(t){if(this._reshapeOnPush)this.load();else{this.fireEvent("changing",[{changes:t}]);var e=this.group(),i=this.items(),n=0,a=this.paginate()||e?t.filter((function(t){return"update"===t.type})):t;e&&(n=Array.isArray(e)?e.length:1),h.applyBatch(this.store(),i,a,n,!0),this._fireChanged([{changes:t}])}},_createLoadOperation:function(t){var e=this._operationManager.add(t),i=this._createStoreLoadOptions();return t.always(function(){this._operationManager.remove(e)}.bind(this)),{operationId:e,storeLoadOptions:i}},reload:function(){var t=this.store();return t instanceof l&&t.clearRawDataCache(),this._init(),this.load()},cancel:function(t){return this._operationManager.cancel(t)},cancelAll:function(){return this._operationManager.cancelAll()},_addSearchOptions:function(t){this._disposed||(this.store()._useDefaultSearch?this._addSearchFilter(t):(t.searchOperation=this._searchOperation,t.searchValue=this._searchValue,t.searchExpr=this._searchExpr))},_createStoreLoadOptions:function(){var t=n({},this._storeLoadOptions);return this._addSearchOptions(t),this._paginate&&this._pageSize&&(t.skip=this._pageIndex*this._pageSize,t.take=this._pageSize),t.userData=this._userData,t},_addSearchFilter:function(t){var e=this._searchValue,i=this._searchOperation,n=this._searchExpr,a=[];e&&(n||(n="this"),Array.isArray(n)||(n=[n]),r.each(n,(function(t,n){a.length&&a.push("or"),a.push([n,i,e])})),t.filter?t.filter=[a,t.filter]:t.filter=a)},_loadFromStore:function(t,e){var i=this;function a(a,r){function s(){var s=n(I(a,r),t);i.fireEvent("customizeLoadResult",[s]),L(s.data).done((function(t){s.data=t,i._processStoreLoadResult(s,e)})).fail(e.reject)}i._disposed||A(e)&&s()}return t.data?(new m).resolve(t.data).done(a):this.store().load(t.storeLoadOptions).done(a).fail(e.reject)},_processStoreLoadResult:function(t,e){var i=this,n=t.data,a=t.extra,r=t.storeLoadOptions;function s(){return i._isLoaded=!0,i._totalCount=isFinite(a.totalCount)?a.totalCount:-1,e.resolve(n,a)}function u(){i.store().totalCount(r).done((function(t){a.totalCount=t,s()})).fail(e.reject)}i._disposed||(n=i._applyPostProcessFunction(i._applyMapFunction(n)),o.isPlainObject(a)||(a={}),i._items=n,(!n.length||!i._paginate||i._pageSize&&n.length<i._pageSize)&&(i._isLastPage=!0),r.requireTotalCount&&!isFinite(a.totalCount)?u():s())},_applyMapFunction:function(t){return this._mapFunc?F(t,this._mapFunc,this.group()):t},_applyPostProcessFunction:function(t){return this._postProcessFunc?this._postProcessFunc(t):t}}).include(p);e.DataSource=z,e.normalizeDataSourceOptions=k,e.normalizeLoadResult=I}

