function module(t,r,e){"use strict";var n=t("../core/class"),i=t("../core/utils/type"),u=t("../core/utils/iterator"),o=t("../core/utils/data").compileGetter,s=t("../core/utils/data").toComparable,c=t("../core/utils/deferred").Deferred,a=t("./errors"),h=t("./utils"),f=n.inherit({toArray:function(){var t=[];for(this.reset();this.next();)t.push(this.current());return t},countable:function(){return!1}}),l=f.inherit({ctor:function(t){this.array=t,this.index=-1},next:function(){return this.index+1<this.array.length&&(this.index++,!0)},current:function(){return this.array[this.index]},reset:function(){this.index=-1},toArray:function(){return this.array.slice(0)},countable:function(){return!0},count:function(){return this.array.length}}),d=f.inherit({ctor:function(t){this.iter=t},next:function(){return this.iter.next()},current:function(){return this.iter.current()},reset:function(){return this.iter.reset()}}),p=d.inherit({ctor:function(t,r){this.callBase(t),this.index=-1,this.mapper=r},current:function(){return this.mapper(this.callBase(),this.index)},next:function(){var t=this.callBase();return t&&this.index++,t}}),v=function(t,r){return t=s(t),r=s(r),null===t&&null!==r?-1:null!==t&&null===r?1:void 0===t&&void 0!==r?1:void 0!==t&&void 0===r?-1:t<r?-1:t>r?1:0},x=f.inherit({ctor:function(t,r,e,n){t instanceof p||(t=new p(t,this._wrap)),this.iter=t,this.rules=[{getter:r,desc:e,compare:n}]},thenBy:function(t,r,e){var n=new x(this.sortedIter||this.iter,t,r,e);return this.sortedIter||(n.rules=this.rules.concat(n.rules)),n},next:function(){return this._ensureSorted(),this.sortedIter.next()},current:function(){return this._ensureSorted(),this.sortedIter.current()},reset:function(){delete this.sortedIter},countable:function(){return this.sortedIter||this.iter.countable()},count:function(){return this.sortedIter?this.sortedIter.count():this.iter.count()},_ensureSorted:function(){var t=this;t.sortedIter||(u.each(t.rules,(function(){this.getter=o(this.getter)})),t.sortedIter=new p(new l(this.iter.toArray().sort((function(r,e){return t._compare(r,e)}))),t._unwrap))},_wrap:function(t,r){return{index:r,value:t}},_unwrap:function(t){return t.value},_compare:function(t,r){var e=t.index,n=r.index;if((t=t.value)===(r=r.value))return e-n;for(var i=0,u=this.rules.length;i<u;i++){var o=this.rules[i],s=o.getter(t),c=o.getter(r),a,h=(o.compare||v)(s,c);if(h)return o.desc?-h:h}return e-n}}),g=function(){var t=function(t){var r=[],e=!1,n=!1;return u.each(t,(function(){if(Array.isArray(this)||i.isFunction(this)){if(r.length>1&&e!==n)throw new a.errors.Error("E4019");r.push(g(this)),e=n,n=!0}else n=h.isConjunctiveOperator(this)})),function(t){for(var n=e,i=0;i<r.length;i++)if(r[i](t)!==e){n=!e;break}return n}},r=function(t){return i.isDefined(t)?t.toString():""},e=function(t){t=h.normalizeBinaryCriterion(t);var e=o(t[0]),i=t[1],u=t[2];switch(u=s(u),i.toLowerCase()){case"=":return n(e,u);case"<>":return n(e,u,!0);case">":return function(t){return s(e(t))>u};case"<":return function(t){return s(e(t))<u};case">=":return function(t){return s(e(t))>=u};case"<=":return function(t){return s(e(t))<=u};case"startswith":return function(t){return 0===s(r(e(t))).indexOf(u)};case"endswith":return function(t){var n=s(r(e(t))),i=r(u);return!(n.length<i.length)&&n.lastIndexOf(u)===n.length-u.length};case"contains":return function(t){return s(r(e(t))).indexOf(u)>-1};case"notcontains":return function(t){return-1===s(r(e(t))).indexOf(u)}}throw a.errors.Error("E4003",i)};function n(t,r,e){return function(n){n=s(t(n));var i=c(r)?n===r:n==r;return e&&(i=!i),i}}function c(t){return""===t||0===t||!1===t}function f(t){var r=t[0],e=g(t[1]);if("!"===r)return function(t){return!e(t)};throw a.errors.Error("E4003",r)}return function(r){return i.isFunction(r)?r:h.isGroupCriterion(r)?t(r):h.isUnaryOperation(r)?f(r):e(r)}}(),m=d.inherit({ctor:function(t,r){this.callBase(t),this.criteria=g(r)},next:function(){for(;this.iter.next();)if(this.criteria(this.current()))return!0;return!1}}),y=f.inherit({ctor:function(t,r){this.iter=t,this.getter=r},next:function(){return this._ensureGrouped(),this.groupedIter.next()},current:function(){return this._ensureGrouped(),this.groupedIter.current()},reset:function(){delete this.groupedIter},countable:function(){return!!this.groupedIter},count:function(){return this.groupedIter.count()},_ensureGrouped:function(){if(!this.groupedIter){var t={},r=[],e=this.iter,n=o(this.getter);for(e.reset();e.next();){var i=e.current(),s=n(i);s in t?t[s].push(i):(t[s]=[i],r.push(s))}this.groupedIter=new l(u.map(r,(function(r){return{key:r,items:t[r]}})))}}}),w=d.inherit({ctor:function(t,r){this.callBase(t),this.getter=o(r)},current:function(){return this.getter(this.callBase())},countable:function(){return this.iter.countable()},count:function(){return this.iter.count()}}),I=d.inherit({ctor:function(t,r,e){this.callBase(t),this.skip=Math.max(0,r),this.take=Math.max(0,e),this.pos=0},next:function(){if(this.pos>=this.skip+this.take)return!1;for(;this.pos<this.skip&&this.iter.next();)this.pos++;return this.pos++,this.iter.next()},reset:function(){this.callBase(),this.pos=0},countable:function(){return this.iter.countable()},count:function(){return Math.min(this.iter.count()-this.skip,this.take)}}),A=function t(r,e){e=e||{},r instanceof f||(r=new l(r));var n=function(t){var r=e.errorHandler;r&&r(t),a._errorHandler(t)},u=function(t){var e,i=(new c).fail(n),u=t.step,o=t.finalize;try{r.reset();for(var s=(e="seed"in t?t.seed:r.next()?r.current():NaN);r.next();)s=u(s,r.current());i.resolve(o?o(s):s)}catch(a){i.reject(a)}return i.promise()},s,d=function(t){return u(h.aggregators[t])},p=function(t){return i.isFunction(t)||Array.isArray(t)||(t=[].slice.call(arguments)),g(new w(r,t))},v=function(t){return p(o(t))},g=function(r){return t(r,e)};return{toArray:function(){return r.toArray()},enumerate:function(){var t=(new c).fail(n);try{t.resolve(r.toArray())}catch(e){t.reject(e)}return t.promise()},sortBy:function(t,e,n){return g(new x(r,t,e,n))},thenBy:function(t,e,n){if(r instanceof x)return g(r.thenBy(t,e,n));throw a.errors.Error("E4004")},filter:function(t){return Array.isArray(t)||(t=[].slice.call(arguments)),g(new m(r,t))},slice:function(t,e){return void 0===e&&(e=Number.MAX_VALUE),g(new I(r,t,e))},select:p,groupBy:function(t){return g(new y(r,t))},aggregate:function(t,r,e){return arguments.length<2?u({step:arguments[0]}):u({seed:t,step:r,finalize:e})},count:function(){if(r.countable()){var t=(new c).fail(n);try{t.resolve(r.count())}catch(e){t.reject(e)}return t.promise()}return d("count")},sum:function(t){return t?v(t).sum():d("sum")},min:function(t){return t?v(t).min():d("min")},max:function(t){return t?v(t).max():d("max")},avg:function(t){return t?v(t).avg():d("avg")}}};e.exports=A}

