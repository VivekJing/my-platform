function module(e,r,t){"use strict";var n=e("../core/renderer"),a=e("./utils"),o=e("./array_utils"),i=e("../core/utils/type").isFunction,u=e("../core/config"),s=e("./errors").errors,l=e("./abstract_store"),c=e("./array_query"),f=e("./store_helper").queryByOptions,_=e("../core/utils/deferred"),h=_.Deferred,d=_.when,p=_.fromPromise,y="totalCount",v="load",w="byKey",m="insert",D="update",F="remove";function E(e){return e&&i(e.then)}function R(e){return(new h).resolve(e).promise()}function b(e,r){if(!i(r))throw s.Error("E4011",e)}function g(e){throw s.Error("E4012",e)}function C(e){function r(e){var r=e[0],t=e[1];return r&&r.getResponseHeader?a.errorMessageFromXhr(r,t):null}return function(t){var n;(n=t instanceof Error?t:new Error(r(arguments)||t&&String(t)||"Unknown error")).message!==a.XHR_ERROR_UNLOAD&&e.reject(n)}}function K(e,r){var t,n=e._loadFunc;return b(v,n),t=n.apply(e,[r]),Array.isArray(t)?t=R(t):null==t?t=R([]):E(t)||g(v),p(t)}function I(e,r){var t,n=e._totalCountFunc;if(!i(n))throw s.Error("E4021");return E(t=n.apply(e,[r]))||(t=Number(t),isFinite(t)||g(y),t=R(t)),p(t)}function M(e,r,t){var n,a=e._byKeyFunc;return b(w,a),E(n=a.apply(e,[r,t]))||(n=R(n)),p(n)}function q(e,r,t,n){if(r.__rawData)n(r.__rawData);else{var a=r.__rawDataPromise||K(r,t);r._cacheRawData&&(r.__rawDataPromise=a),a.always((function(){delete r.__rawDataPromise})).done((function(e){r._cacheRawData&&(r.__rawData=e),n(e)})).fail(C(e))}}function H(e,r,t,a){var o={};"userData"in(t=t||{})&&(o.userData=t.userData),q(e,r,o,(function(o){var i,u,s=c(o,{errorHandler:r._errorHandler}),l=[],_,h;a||((i=f(s,t))===s?_=o.slice(0):l.push(i.enumerate().done((function(e){_=e})))),(t.requireTotalCount||a)&&((u=f(s,t,!0))===s?h=o.length:l.push(u.count().done((function(e){h=e})))),d.apply(n,l).done((function(){a?e.resolve(h):t.requireTotalCount?e.resolve(_,{totalCount:h}):e.resolve(_)})).fail((function(r){e.reject(r)}))}))}function k(e,r,t){q(e,r,{},(function(n){for(var o,i=r.key(),u=0,l=n.length;u<l;u++)if(o=n[u],a.keysEqual(i,r.keyOf(n[u]),t))return void e.resolve(o);e.reject(s.Error("E4009"))}))}var L=l.inherit({ctor:function(e){e=e||{},this.callBase(e),this._useDefaultSearch=!!e.useDefaultSearch||"raw"===e.loadMode,this._loadMode=e.loadMode,this._cacheRawData=!1!==e.cacheRawData,this._loadFunc=e[v],this._totalCountFunc=e[y],this._byKeyFunc=e[w],this._insertFunc=e.insert,this._updateFunc=e.update,this._removeFunc=e.remove},createQuery:function(){throw s.Error("E4010")},clearRawDataCache:function(){delete this.__rawData},_totalCountImpl:function(e){var r=new h;return"raw"!==this._loadMode||this._totalCountFunc?(I(this,e).done((function(e){r.resolve(Number(e))})).fail(C(r)),r=this._addFailHandlers(r)):H(r,this,e,!0),r.promise()},_pushImpl:function(e){this.__rawData&&o.applyBatch(this,this.__rawData,e)},_loadImpl:function(e){var r=new h;return"raw"===this._loadMode?H(r,this,e,!1):(K(this,e).done((function(e,t){r.resolve(e,t)})).fail(C(r)),r=this._addFailHandlers(r)),r.promise()},_byKeyImpl:function(e,r){var t=new h;return this._byKeyViaLoad()?(this._requireKey(),k(t,this,e)):M(this,e,r).done((function(e){t.resolve(e)})).fail(C(t)),t.promise()},_byKeyViaLoad:function(){return"raw"===this._loadMode&&!this._byKeyFunc},_insertImpl:function(e){var r,t=this,n=t._insertFunc,a=new h;return b(m,n),E(r=n.apply(t,[e]))||(r=R(r)),p(r).done((function(r){u().useLegacyStoreResult?a.resolve(e,r):a.resolve(r||e,t.keyOf(r))})).fail(C(a)),a.promise()},_updateImpl:function(e,r){var t,n=this._updateFunc,a=new h;return b(D,n),E(t=n.apply(this,[e,r]))||(t=R(t)),p(t).done((function(t){u().useLegacyStoreResult?a.resolve(e,r):a.resolve(t||r,e)})).fail(C(a)),a.promise()},_removeImpl:function(e){var r,t=this._removeFunc,n=new h;return b(F,t),E(r=t.apply(this,[e]))||(r=R()),p(r).done((function(){n.resolve(e)})).fail(C(n)),n.promise()}});t.exports=L,t.exports.default=t.exports}

