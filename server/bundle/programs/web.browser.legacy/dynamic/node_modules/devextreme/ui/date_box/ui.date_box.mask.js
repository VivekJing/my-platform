function module(t,e,a){"use strict";var i=t("../../events/utils"),s=t("../../core/utils/type"),r=t("../../core/utils/dom"),n=t("../../core/utils/extend"),l=t("../../core/utils/math"),h,u=P(t("../../events/core/events_engine")),_=t("./ui.date_box.mask.parts"),c,o=P(t("../../localization/date")),d=t("../../localization/ldml/date.parser"),f=t("../../localization/ldml/date.format"),v,p=P(t("./ui.date_box.base"));function P(t){return t&&t.__esModule?t:{default:t}}var m="dateBoxMask",g=1,k=-1,x=p.default.inherit({_supportedKeys:function(t){var e=this,a=this.callBase(t),s=function(t){var s=a[(0,i.normalizeKeyName)(t)];return s&&s.apply(e,[t])},r=function(t,a){return e._shouldUseOriginalHandler(t)?s.apply(e,[t]):a.apply(e,[t])};return(0,n.extend)({},a,{del:function(t){return r(t,(function(t){e._revertPart(1),e._isAllSelected()||t.preventDefault()}))},backspace:function(t){return r(t,(function(t){e._revertPart(-1),e._isAllSelected()||t.preventDefault()}))},home:function(t){return r(t,(function(t){e._selectFirstPart(),t.preventDefault()}))},end:function(t){return r(t,(function(t){e._selectLastPart(),t.preventDefault()}))},escape:function(t){return r(t,(function(t){e._revertChanges(t)}))},enter:function(t){return r(t,(function(t){e._enterHandler(t)}))},leftArrow:function(t){return r(t,(function(t){e._selectNextPart(-1),t.preventDefault()}))},rightArrow:function(t){return r(t,(function(t){e._selectNextPart(1),t.preventDefault()}))},upArrow:function(t){return r(t,(function(t){e._upDownArrowHandler(1),t.preventDefault()}))},downArrow:function(t){return r(t,(function(t){e._upDownArrowHandler(-1),t.preventDefault()}))}})},_shouldUseOriginalHandler:function(t){return!this._useMaskBehavior()||this.option("opened")||t&&t.altKey},_upDownArrowHandler:function(t){this._setNewDateIfEmpty();var e=this._getActivePartValue(this._initialMaskValue),a,i=this._getActivePartValue()-e;this._loadMaskValue(this._initialMaskValue),this._partIncrease(i+t)},_getDefaultOptions:function(){return(0,n.extend)(this.callBase(),{useMaskBehavior:!1,emptyDateValue:new Date(2e3,0,1,0,0,0),advanceCaret:!0})},_isSingleCharKey:function(t){var e=t.originalEvent.key;return"string"==typeof e&&1===e.length&&!t.ctrl&&!t.alt},_keyboardHandler:function(t){var e=t.originalEvent.key,a=this.callBase(t);return this._useMaskBehavior()&&this._isSingleCharKey(t)?(this._isAllSelected()&&(this._activePartIndex=0),this._setNewDateIfEmpty(),isNaN(parseInt(e))?this._searchString(e):this._searchNumber(e),t.originalEvent.preventDefault(),a):a},_isAllSelected:function(){var t=this._caret();return t.end-t.start===this.option("text").length},_getFormatPattern:function(){if(this._formatPattern)return this._formatPattern;var t=this._strategy.getDisplayFormat(this.option("displayFormat")),e=(0,s.isString)(t)&&!o.default._getPatternByFormat(t);return this._formatPattern=e?t:(0,f.getFormat)((function(e){return o.default.format(e,t)})),this._formatPattern},_setNewDateIfEmpty:function(){this._maskValue||(this._maskValue=new Date,this._initialMaskValue=new Date,this._renderDateParts())},_searchNumber:function(t){var e,a=this._getActivePartLimits().max,i=String(a).length,s=this._getActivePartProp("pattern").length;if(this._searchValue=(this._searchValue+t).substr(-i),isNaN(this._searchValue)&&(this._searchValue=t),this._setActivePartValue(this._searchValue),this.option("advanceCaret")){var r,n=1===s?i:Math.min(s,i),l=this._searchValue.length===n,h=parseInt(this._searchValue+"0")>a;(l||h)&&this._selectNextPart(1)}},_searchString:function(t){if(isNaN(parseInt(this._getActivePartProp("text")))){for(var e=this._getActivePartProp("limits")(this._maskValue),a=this._searchValue+t.toLowerCase(),i=e.max-e.min,s=0;s<=i;s++)if(this._loadMaskValue(this._initialMaskValue),this._partIncrease(s+1),0===this._getActivePartProp("text").toLowerCase().indexOf(a))return void(this._searchValue=a);this._setNewDateIfEmpty(),this._searchValue&&(this._clearSearchValue(),this._searchString(t))}},_clearSearchValue:function(){this._searchValue=""},_revertPart:function(t){if(!this._isAllSelected()){var e=this._getActivePartValue(this.option("emptyDateValue"));this._setActivePartValue(e),this._selectNextPart(t)}this._clearSearchValue()},_useMaskBehavior:function(){return this.option("useMaskBehavior")&&"text"===this.option("mode")},_initMaskState:function(){this._activePartIndex=0,this._formatPattern=null,this._regExpInfo=(0,d.getRegExpInfo)(this._getFormatPattern(),o.default),this._loadMaskValue()},_renderMask:function(){this.callBase(),this._detachMaskEvents(),this._clearMaskState(),this._useMaskBehavior()&&(this._attachMaskEvents(),this._initMaskState(),this._renderDateParts())},_renderDateParts:function(){if(this._useMaskBehavior()){var t=this.option("text")||this._getDisplayedText(this._maskValue);t&&(this._dateParts=(0,_.renderDateParts)(t,this._regExpInfo),this._selectNextPart())}},_detachMaskEvents:function(){u.default.off(this._input(),".dateBoxMask")},_attachMaskEvents:function(){var t=this;u.default.on(this._input(),(0,i.addNamespace)("dxclick","dateBoxMask"),this._maskClickHandler.bind(this)),u.default.on(this._input(),(0,i.addNamespace)("paste","dateBoxMask"),this._maskPasteHandler.bind(this)),u.default.on(this._input(),(0,i.addNamespace)("drop","dateBoxMask"),(function(){t._renderDisplayText(t._getDisplayedText(t._maskValue)),t._selectNextPart()}))},_selectLastPart:function(){this.option("text")&&(this._activePartIndex=this._dateParts.length,this._selectNextPart(-1))},_selectFirstPart:function(){this.option("text")&&(this._activePartIndex=-1,this._selectNextPart(1))},_onMouseWheel:function(t){this._useMaskBehavior()&&this._partIncrease(t.delta>0?1:-1,t)},_selectNextPart:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;if(this.option("text")){t&&(this._initialMaskValue=new Date(this._maskValue));var e=(0,l.fitIntoRange)(this._activePartIndex+t,0,this._dateParts.length-1);if(this._dateParts[e].isStub){var a=0===e&&t<0||e===this._dateParts.length-1&&t>0;if(!a)return void this._selectNextPart(t>=0?t+1:t-1);e=this._activePartIndex}this._activePartIndex!==e&&this._clearSearchValue(),this._activePartIndex=e,this._caret(this._getActivePartProp("caret"))}},_getActivePartLimits:function(){var t;return this._getActivePartProp("limits")(this._maskValue)},_getActivePartValue:function(t){t=t||this._maskValue;var e=this._getActivePartProp("getter");return(0,s.isFunction)(e)?e(t):t[e]()},_addLeadingZeroes:function(t){var e=this._searchValue.match(/^0+/),a=this._getActivePartLimits(),i=String(a.max).length;return((e&&e[0]||"")+String(t)).substr(-i)},_setActivePartValue:function(t,e){e=e||this._maskValue;var a=this._getActivePartProp("setter"),i=this._getActivePartLimits();t=(0,l.inRange)(t,i.min,i.max)?t:t%10,t=this._addLeadingZeroes((0,l.fitIntoRange)(t,i.min,i.max)),(0,s.isFunction)(a)?a(e,t):e[a](t),this._renderDisplayText(this._getDisplayedText(e)),this._renderDateParts()},_getActivePartProp:function(t){if(this._dateParts&&this._dateParts[this._activePartIndex])return this._dateParts[this._activePartIndex][t]},_loadMaskValue:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.dateOption("value");this._maskValue=t&&new Date(t),this._initialMaskValue=t&&new Date(t)},_saveMaskValue:function(){var t=this._maskValue&&new Date(this._maskValue);this._initialMaskValue=new Date(t),this.dateOption("value",t)},_revertChanges:function(){this._loadMaskValue(),this._renderDisplayText(this._getDisplayedText(this._maskValue)),this._renderDateParts()},_renderDisplayText:function(t){this.callBase(t),this._useMaskBehavior()&&this.option("text",t)},_partIncrease:function(t){this._setNewDateIfEmpty();var e=this._getActivePartLimits(),a=e.max,i=e.min,s=a-i;1===s&&s++;var r=t+this._getActivePartValue();r>a?r=this._applyLimits(r,{limitBase:i,limitClosest:a,limitDelta:s}):r<i&&(r=this._applyLimits(r,{limitBase:a,limitClosest:i,limitDelta:s})),this._setActivePartValue(r)},_applyLimits:function(t,e){var a=e.limitBase,i=e.limitClosest,s,r=(t-i)%e.limitDelta;return r?a+r-1*(0,l.sign)(r):i},_maskClickHandler:function(){this.option("text")&&(this._activePartIndex=(0,_.getDatePartIndexByPosition)(this._dateParts,this._caret().start),this._caret(this._getActivePartProp("caret")))},_maskPasteHandler:function(t){var e=this._replaceSelectedText(this.option("text"),this._caret(),(0,r.clipboardText)(t)),a=o.default.parse(e,this._getFormatPattern());a&&(this._maskValue=a,this._renderDisplayText(this._getDisplayedText(this._maskValue)),this._renderDateParts(),this._selectNextPart()),t.preventDefault()},_isValueDirty:function(){var t=this.dateOption("value");return(this._maskValue&&this._maskValue.getTime())!==(t&&t.getTime())},_fireChangeEvent:function(){this._clearSearchValue(),this._isValueDirty()&&u.default.trigger(this._input(),"change")},_enterHandler:function(t){this._fireChangeEvent(),this._selectNextPart(1),t.preventDefault()},_focusOutHandler:function(t){this.callBase(t),this._useMaskBehavior()&&(this._fireChangeEvent(),this._selectFirstPart(t))},_valueChangeEventHandler:function(t){this._useMaskBehavior()?(this._saveValueChangeEvent(t),this.option("text")||(this._maskValue=null),this._saveMaskValue()):this.callBase(t)},_optionChanged:function(t){switch(t.name){case"useMaskBehavior":this._renderMask();break;case"displayFormat":case"mode":this.callBase(t),this._renderMask();break;case"value":this._loadMaskValue(),this.callBase(t),this._renderDateParts();break;case"advanceCaret":case"emptyDateValue":break;default:this.callBase(t)}},_clearMaskState:function(){this._clearSearchValue(),delete this._dateParts,delete this._activePartIndex,delete this._maskValue},reset:function(){this.callBase(),this._clearMaskState(),this._activePartIndex=0},_clean:function(){this.callBase(),this._detachMaskEvents(),this._clearMaskState()}});a.exports=x}

