function module(t,e,a){"use strict";var i=t("../../events/core/events_engine"),s=t("../../core/utils/extend").extend,r=t("../../core/utils/type").isNumeric,n=t("../../core/utils/browser"),u=t("../../core/devices"),o=t("../../core/utils/math").fitIntoRange,h=t("../../core/utils/math").inRange,l=t("../../core/utils/common").escapeRegExp,_=t("../../localization/number"),c=t("./number_box.caret"),d=t("../../localization/ldml/number").getFormat,m=t("./number_box.base"),f=t("../../events/utils"),v=t("../../core/utils/type"),p="dxNumberFormatter",g=1,V=-1,y="-",B="minus",b="Subtract",T="input",F=n.msie?300:0,P=function(t,e){return void 0===t?e:t},x=m.inherit({_getDefaultOptions:function(){return s(this.callBase(),{useMaskBehavior:!0,format:null})},_isDeleteKey:function(t){return"del"===t},_supportedKeys:function(){if(!this._useMaskBehavior())return this.callBase();var t=this;return s(this.callBase(),{minus:this._revertSign.bind(this),del:this._removeHandler.bind(this),backspace:this._removeHandler.bind(this),leftArrow:this._arrowHandler.bind(this,-1),rightArrow:this._arrowHandler.bind(this,1),home:this._moveCaretToBoundaryEventHandler.bind(this,1),enter:this._updateFormattedValue.bind(this),end:this._moveCaretToBoundaryEventHandler.bind(this,-1)})},_focusInHandler:function(t){this.callBase(t),this.clearCaretTimeout(),this._caretTimeout=setTimeout(function(){this._caretTimeout=null;var e=this._caret();e.start===e.end&&this._moveCaretToBoundaryEventHandler(-1,t)}.bind(this),F)},_focusOutHandler:function(t){this._focusOutOccurs=!0,this._useMaskBehavior()&&this._updateFormattedValue(),this.callBase(t),this._focusOutOccurs=!1},_hasValueBeenChanged:function(t){var e=this._getFormatPattern(),a=this.option("value"),i;return(this._format(a,e)||"")!==t},_updateFormattedValue:function(){var t=this._getInputVal();this._hasValueBeenChanged(t)&&(this._parsedValue=this._tryParse(t,this._caret()),this._adjustParsedValue(),this._setTextByParsedValue(),this._parsedValue!==this.option("value")&&i.trigger(this._input(),"change"))},_arrowHandler:function(t,e){if(this._useMaskBehavior()){var a=this._getInputVal(),i=this._getFormatPattern(),s=c.getCaretWithOffset(this._caret(),t);c.isCaretInBoundaries(s,a,i)||(s=1===t?s.end:s.start,e.preventDefault(),this._caret(c.getCaretInBoundaries(s,a,i)))}},_moveCaretToBoundary:function(t){var e=c.getCaretBoundaries(this._getInputVal(),this._getFormatPattern()),a=c.getCaretWithOffset(1===t?e.start:e.end,0);this._caret(a)},_moveCaretToBoundaryEventHandler:function(t,e){!this._useMaskBehavior()||e&&e.shiftKey||(this._moveCaretToBoundary(t),e&&e.preventDefault())},_shouldMoveCaret:function(t,e){var a=_.getDecimalSeparator(),i=t.charAt(e.end)===a,s="0"===t.charAt(e.end),r=(this._lastKey===a||"."===this._lastKey)&&i,n="0"===this._lastKey&&s;return r||n},_getInputVal:function(){return _.convertDigits(this._input().val(),!0)},_keyboardHandler:function(t){if(this.clearCaretTimeout(),this._lastKey=_.convertDigits(f.getChar(t),!0),this._lastKeyName=f.normalizeKeyName(t),!this._shouldHandleKey(t.originalEvent))return this.callBase(t);var e=this._getInputVal(),a=this._caret(),i="minus"===this._lastKeyName?"":this._lastKey,s=this._tryParse(e,a,i);return void 0===s?("minus"!==this._lastKeyName&&t.originalEvent.preventDefault(),this._shouldMoveCaret(e,a)&&this._moveCaret(1)):this._parsedValue=s,this.callBase(t)},_keyPressHandler:function(t){this._useMaskBehavior()||this.callBase(t)},_removeHandler:function(t){var e=this._caret(),a=this._getInputVal(),i=e.start,s=e.end;this._lastKey=f.getChar(t),this._lastKeyName=f.normalizeKeyName(t);var r=this._isDeleteKey(this._lastKeyName),n=!r;if(i===s){var u=i,o;if(!(n&&i>0||r&&i<a.length))return void t.preventDefault();r&&s++,n&&i--}var h=a.slice(i,s);if(this._isStub(h))return this._moveCaret(r?1:-1),(this._parsedValue<0||1/this._parsedValue==-1/0)&&(this._revertSign(t),this._setTextByParsedValue()),void t.preventDefault();var l=_.getDecimalSeparator();if(h!==l){var c,d;if(s-i<a.length)if(this._replaceSelectedText(a,{start:i,end:s},"").search(/[0-9]/)<0&&this._isValueInRange(0))return void(this._parsedValue=this._parsedValue<0||1/this._parsedValue==-1/0?-0:0);var m=this._tryParse(a,{start:i,end:s},"");void 0===m?t.preventDefault():this._parsedValue=m}else{var v=a.indexOf(l);this._isNonStubAfter(v+1)&&(this._moveCaret(r?1:-1),t.preventDefault())}},_isPercentFormat:function(){var t,e;return-1!==this._getFormatPattern().replace(/'[^']+'/g,"").indexOf("%")},_parse:function(t,e){var a=this.option("format"),i,s;return(v.isFunction(a.formatter)?a.parser:_.parse)(t,e)},_format:function(t,e){var a=this.option("format"),i,s;return(v.isFunction(a.formatter)?a.formatter:_.format)(t,e)},_getFormatPattern:function(){var t=this.option("format"),e;return"string"==typeof t&&(t.indexOf("0")>=0||t.indexOf("#")>=0)?t:d(function(e){var a=this._format(e,t);return _.convertDigits(a,!0)}.bind(this))},_getFormatForSign:function(t){var e=this._getFormatPattern(),a=e.split(";"),i=_.getSign(t,e);return a[1]=a[1]||"-"+a[0],i<0?a[1]:a[0]},_removeStubs:function(t,e){var a=this._getFormatForSign(t),i=_.getThousandsSeparator(),s=a.replace(/[#0.,]/g,""),r=new RegExp("[-"+l((e?"":i)+s)+"]","g");return t.replace(r,"")},_truncateToPrecision:function(t,e){if(v.isDefined(t)){var a=t.toString(),i=a.indexOf(".");if(a&&i>-1){var s=parseFloat(a.substr(0,i+e+1));return isNaN(s)?t:s}}return t},_tryParse:function(t,e,a){var i=this._replaceSelectedText(t,e,a),s=this._getFormatPattern(),r=e.start!==e.end,n=this._parse(i,s),u=this._getPrecisionLimits(s,i).max,o=n!==this._parsedValue,h,l=a===_.getDecimalSeparator()&&0===u,c=!r&&!o&&"-"!==a&&!this._isValueIncomplete(i)&&this._isStub(a);if(!l&&!c&&(""===this._removeStubs(i)&&(n=0*this._parsedValue),!isNaN(n))){var d=null===n?this._parsedValue:n;return n=this._truncateToPrecision(d,u),this._isPercentFormat()?n&&n/100:n}},_isValueIncomplete:function(t){if(!this._useMaskBehavior())return this.callBase(t);var e=this._caret(),a=_.getDecimalSeparator(),i=t.indexOf(a),s=i>=0&&i<e.start,r=this._removeStubs(t,!0).split(a);if(!s||2!==r.length)return!1;var n=r[1].length,u=this._getPrecisionLimits(this._getFormatPattern(),t),o=h(n,u.min,u.max),l="0"===r[1].charAt(n-1);return o&&(l||!n)},_isValueInRange:function(t){var e=P(this.option("min"),-1/0),a=P(this.option("max"),1/0);return h(t,e,a)},_setInputText:function(t){var e=_.convertDigits(t,!0),a=c.getCaretAfterFormat(this._getInputVal(),e,this._caret(),this._getFormatPattern());this._input().val(t),this._toggleEmptinessEventHandler(),this._formattedValue=t,this._focusOutOccurs||this._caret(a)},_useMaskBehavior:function(){return!!this.option("format")&&this.option("useMaskBehavior")},_renderInputType:function(){var t="number"===this.option("mode"),e="desktop"===u.real().deviceType;this._useMaskBehavior()&&t?this._setInputType(e||this._isSupportInputMode()?"text":"tel"):this.callBase()},_isChar:function(t){return"string"==typeof t&&1===t.length},_moveCaret:function(t){if(t){var e=c.getCaretWithOffset(this._caret(),t),a=c.getCaretInBoundaries(e,this._getInputVal(),this._getFormatPattern());this._caret(a)}},_shouldHandleKey:function(t){var e=f.normalizeKeyName(t),a=t.ctrlKey||t.shiftKey||t.altKey||!this._isChar(e),i="minus"===e,s;return this._useMaskBehavior()&&!a&&!i},_renderInput:function(){this.callBase(),this._renderFormatter()},_renderFormatter:function(){this._clearCache(),this._detachFormatterEvents(),this._useMaskBehavior()&&this._attachFormatterEvents()},_detachFormatterEvents:function(){i.off(this._input(),".dxNumberFormatter")},_isInputFromPaste:function(t){var e=t.originalEvent&&t.originalEvent.inputType;return v.isDefined(e)?"insertFromPaste"===e:this._isValuePasted},_attachFormatterEvents:function(){var t=this._input();i.on(t,f.addNamespace("input","dxNumberFormatter"),function(t){this._formatValue(t),this._isValuePasted=!1}.bind(this)),n.msie&&n.version<12&&i.on(t,f.addNamespace("paste","dxNumberFormatter"),function(){this._isValuePasted=!0}.bind(this)),i.on(t,f.addNamespace("dxclick","dxNumberFormatter"),function(){this._caretTimeout||(this._caretTimeout=setTimeout(function(){this._caret(c.getCaretInBoundaries(this._caret(),this._getInputVal(),this._getFormatPattern()))}.bind(this),F))}.bind(this)),i.on(t,"dxdblclick",function(){this.clearCaretTimeout()}.bind(this))},clearCaretTimeout:function(){clearTimeout(this._caretTimeout),this._caretTimeout=null},_forceRefreshInputValue:function(){if(!this._useMaskBehavior())return this.callBase()},_isNonStubAfter:function(t,e){return(e=(e||this._getInputVal()).slice(t))&&!this._isStub(e,!0)},_isStub:function(t,e){var a=l(_.getDecimalSeparator()),i,s;return new RegExp("^[^0-9"+a+"]+$","g").test(t)&&(e||this._isChar(t))},_parseValue:function(t){return this._useMaskBehavior()?this._parsedValue:this.callBase(t)},_getPrecisionLimits:function(t){var e,a=(this._getFormatForSign(t).split(".")[1]||"").replace(/[^#0]/g,""),i,s;return{min:a.replace(/^(0*)#*/,"$1").length,max:a.length}},_revertSign:function(t){if(this._useMaskBehavior()){var e=this._caret();if(e.start!==e.end){if("minus"===f.normalizeKeyName(t))return void this._applyRevertedSign(t,e,!0);this._caret(c.getCaretInBoundaries(0,this._getInputVal(),this._getFormatPattern()))}this._applyRevertedSign(t,e)}},_applyRevertedSign:function(t,e,a){var s=-1*P(this._parsedValue,null);if(this._isValueInRange(s)){if(this._parsedValue=s,a){var r=this._getFormatPattern(),u=this._getInputVal();this._setTextByParsedValue(),t.preventDefault();var o=this._getInputVal(),h=c.getCaretOffset(u,o,r);e=c.getCaretWithOffset(e,h);var l=c.getCaretInBoundaries(e,o,r);n.msie?(clearTimeout(this._caretTimeout),this._caretTimeout=setTimeout(this._caret.bind(this,l))):this._caret(l)}"Subtract"===t.key&&i.trigger(this._input(),"input")}},_removeMinusFromText:function(t,e){var a;return"minus"===this._lastKeyName&&"-"===t.charAt(e.start-1)?this._replaceSelectedText(t,{start:e.start-1,end:e.start},""):t},_setTextByParsedValue:function(){var t=this._getFormatPattern(),e=this._parseValue(),a=this._format(e,t)||"";this._setInputText(a)},_formatValue:function(t){var e=this._getInputVal(),a=this._caret(),i=this._removeMinusFromText(e,a),s=i!==e,r;if(e=i,!this._isInputFromPaste(t)&&this._isValueIncomplete(i))return this._formattedValue=e,void(s&&this._setTextByParsedValue());if(_.convertDigits(this._formattedValue,!0)!==e){var n=this._tryParse(e,a,"");v.isDefined(n)&&(this._parsedValue=n)}this._setTextByParsedValue()},_renderDisplayText:function(){this._useMaskBehavior()?this._toggleEmptinessEventHandler():this.callBase.apply(this,arguments)},_renderValue:function(){this._useMaskBehavior()&&(this._parsedValue=this.option("value"),this._setTextByParsedValue()),this.callBase()},_adjustParsedValue:function(){if(this._useMaskBehavior()){var t,e=this._removeStubs(this._getInputVal())?this._parseValue():null;r(e)?this._parsedValue=o(e,this.option("min"),this.option("max")):this._parsedValue=e}},_valueChangeEventHandler:function(t){if(!this._useMaskBehavior())return this.callBase(t);var e=this._caret();this._saveValueChangeEvent(t),this._lastKey=null,this._lastKeyName=null,this._adjustParsedValue(),this.option("value",this._parsedValue),e&&this._caret(e)},_optionChanged:function(t){switch(t.name){case"format":case"useMaskBehavior":this._renderFormatter(),this._renderValue();break;case"min":case"max":this._adjustParsedValue(),this.callBase(t);break;default:this.callBase(t)}},_optionValuesEqual:function(t,e,a){return"value"===t&&0===e&&0===a?1/e==1/a:this.callBase.apply(this,arguments)},_clearCache:function(){delete this._formattedValue,delete this._lastKey,delete this._lastKeyName,delete this._parsedValue,delete this._focusOutOccurs,clearTimeout(this._caretTimeout),delete this._caretTimeout},_clean:function(){this._clearCache(),this.callBase()}});a.exports=x}

