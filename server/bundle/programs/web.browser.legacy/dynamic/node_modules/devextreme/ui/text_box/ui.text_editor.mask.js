function module(e,t,a){"use strict";var s=e("../../core/renderer"),i=e("./utils.caret"),n=e("../../core/utils/dom"),r=e("../../core/utils/iterator").each,h=e("../../events/utils"),o=e("../../events/core/events_engine"),l=e("../../core/utils/extend").extend,d=e("../widget/selectors").focused,u=e("../../core/utils/array").inArray,c=e("../../core/utils/type").isDefined,_=e("../../localization/message"),k=e("../../core/utils/common").noop,m=e("../../core/utils/string"),p=e("../../events/core/wheel"),f=e("./ui.text_editor.mask.rule"),v=e("./ui.text_editor.base"),M=function(){return{}},C=" ",y="\\",g="dx-texteditor-masked",H="dxMask",x="forward",w="backward",E="blur beforedeactivate",b="deleteContentBackward",R={0:/[0-9]/,9:/[0-9\s]/,"#":/[-+0-9\s]/,L:function(e){return V(e)},l:function(e){return V(e)||K(e)},C:/\S/,c:/./,A:function(e){return V(e)||T(e)},a:function(e){return V(e)||T(e)||K(e)}},T=function(e){return/[0-9]/.test(e)},V=function(e){var t=e.charCodeAt();return 64<t&&t<91||96<t&&t<123||t>127},K=function(e){return" "===e},D=v.inherit({_getDefaultOptions:function(){return l(this.callBase(),{mask:"",maskChar:"_",maskRules:{},maskInvalidMessage:_.format("validation-mask"),useMaskedValue:!1,showMaskMode:"always"})},_supportedKeys:function(){var e=this,t={backspace:e._maskBackspaceHandler,del:e._maskDelHandler,enter:e._changeHandler},a=e.callBase();return r(t,(function(t,s){var i=a[t];a[t]=function(t){e.option("mask")&&s.call(e,t),i&&i(t)}})),a},_getSubmitElement:function(){return this.option("mask")?this._$hiddenElement:this.callBase()},_initMarkup:function(){this._renderHiddenElement(),this.callBase()},_attachMouseWheelEventHandlers:function(){var e;if(this._onMouseWheel!==k){var t=this._input(),a=h.addNamespace(p.name,this.NAME),s=this._createAction(function(e){if(d(t)){var a=e.event;this._onMouseWheel(a),a.preventDefault(),a.stopPropagation()}}.bind(this));o.off(t,a),o.on(t,a,(function(e){s({event:e})}))}},_onMouseWheel:k,_render:function(){this.callBase(),this._renderMask(),this._attachMouseWheelEventHandlers()},_renderHiddenElement:function(){this.option("mask")&&(this._$hiddenElement=s("<input>").attr("type","hidden").appendTo(this._inputWrapper()))},_removeHiddenElement:function(){this._$hiddenElement&&this._$hiddenElement.remove()},_renderMask:function(){this.$element().removeClass("dx-texteditor-masked"),this._maskRulesChain=null,this._detachMaskEventHandlers(),this.option("mask")&&(this.$element().addClass("dx-texteditor-masked"),this._attachMaskEventHandlers(),this._parseMask(),this._renderMaskedValue(),this._changedValue=this._input().val())},_attachMaskEventHandlers:function(){var e=this._input();o.on(e,h.addNamespace("focusin","dxMask"),this._maskFocusHandler.bind(this)),o.on(e,h.addNamespace("focusout","dxMask"),this._maskBlurHandler.bind(this)),o.on(e,h.addNamespace("keydown","dxMask"),this._maskKeyDownHandler.bind(this)),o.on(e,h.addNamespace("keypress","dxMask"),this._maskKeyPressHandler.bind(this)),o.on(e,h.addNamespace("input","dxMask"),this._maskInputHandler.bind(this)),o.on(e,h.addNamespace("paste","dxMask"),this._maskPasteHandler.bind(this)),o.on(e,h.addNamespace("cut","dxMask"),this._maskCutHandler.bind(this)),o.on(e,h.addNamespace("drop","dxMask"),this._maskDragHandler.bind(this)),this._attachChangeEventHandlers()},_detachMaskEventHandlers:function(){o.off(this._input(),".dxMask")},_attachChangeEventHandlers:function(){-1!==u("change",this.option("valueChangeEvent").split(" "))&&o.on(this._input(),h.addNamespace(E,"dxMask"),function(e){this._suppressCaretChanging(this._changeHandler,[e]),this._changeHandler(e)}.bind(this))},_suppressCaretChanging:function(e,t){var a=i;i=M;try{e.apply(this,t)}finally{i=a}},_changeHandler:function(e){var t=this._input(),a=t.val();if(a!==this._changedValue){this._changedValue=a;var s=h.createEvent(e,{type:"change"});o.trigger(t,s)}},_parseMask:function(){this._maskRules=l({},R,this.option("maskRules")),this._maskRulesChain=this._parseMaskRule(0)},_parseMaskRule:function(e){var t=this.option("mask");if(e>=t.length)return new f.EmptyMaskRule;var a=t[e],s="\\"===a,i=s?new f.StubMaskRule({maskChar:t[e+1]}):this._getMaskRule(a);return i.next(this._parseMaskRule(e+1+s)),i},_getMaskRule:function(e){var t;return r(this._maskRules,(function(a,s){if(a===e)return t={pattern:a,allowedChars:s},!1})),c(t)?new f.MaskRule(l({maskChar:this.option("maskChar")},t)):new f.StubMaskRule({maskChar:e})},_renderMaskedValue:function(){if(this._maskRulesChain){var e=this.option("value")||"";this._maskRulesChain.clear(this._normalizeChainArguments());var t={length:e.length};t[this._isMaskedValueMode()?"text":"value"]=e,this._handleChain(t),this._displayMask()}},_replaceSelectedText:function(e,t,a){return void 0===a?e:e.slice(0,t.start)+a+e.slice(t.end);var s,i,n},_isMaskedValueMode:function(){return this.option("useMaskedValue")},_displayMask:function(e){e=e||this._caret(),this._renderValue(),this._caret(e)},_isValueEmpty:function(){return m.isEmpty(this._value)},_shouldShowMask:function(){var e;return"onFocus"!==this.option("showMaskMode")||(d(this._input())||!this._isValueEmpty())},_showMaskPlaceholder:function(){if(this._shouldShowMask()){var e=this._maskRulesChain.text();this.option("text",e),"onFocus"===this.option("showMaskMode")&&this._renderDisplayText(e)}},_renderValue:function(){if(this._maskRulesChain){var e=this._maskRulesChain.text();if(this._showMaskPlaceholder(),this._$hiddenElement){var t=this._maskRulesChain.value(),a=this._isMaskedValueMode()?e:t;this._$hiddenElement.val(m.isEmpty(t)?"":a)}}this.callBase()},_valueChangeEventHandler:function(e){this._maskRulesChain?(this._saveValueChangeEvent(e),this.option("value",this._convertToValue().replace(/\s+$/,""))):this.callBase.apply(this,arguments)},_maskFocusHandler:function(){if(this._showMaskPlaceholder(),this._direction("forward"),!this._isValueEmpty()&&this.option("isValid"))this._adjustCaret();else{var e=this._maskRulesChain.first();this._caretTimeout=setTimeout(function(){this._caret({start:e,end:e})}.bind(this),0)}},_maskBlurHandler:function(){"onFocus"===this.option("showMaskMode")&&this._isValueEmpty()&&(this.option("text",""),this._renderDisplayText(""))},_maskKeyDownHandler:function(){this._keyPressHandled=!1},_maskKeyPressHandler:function(e){this._keyPressHandled||(this._keyPressHandled=!0,this._isControlKeyFired(e)||this._maskKeyHandler(e,(function(){return this._handleKey(h.getChar(e)),!0})))},_maskInputHandler:function(e){if(this._backspaceInputHandled(e.originalEvent&&e.originalEvent.inputType)&&this._handleBackspaceInput(e),!this._keyPressHandled){this._keyPressHandled=!0;var t=this._input().val(),a=this._caret();if(a.end){a.start=a.end-1;var s=t.substring(0,a.start)+t.substring(a.end),i=t[a.start];this._input().val(s),this._inputHandlerTimer=setTimeout(function(){this._caret({start:a.start,end:a.start}),this._maskKeyHandler(e,(function(){return this._handleKey(i),!0}))}.bind(this))}}},_backspaceInputHandled:function(e){return e===b&&!this._keyPressHandled},_handleBackspaceInput:function(e){var t=this._caret();this._caret({start:t.start+1,end:t.end+1}),this._maskBackspaceHandler(e)},_isControlKeyFired:function(e){return this._isControlKey(h.normalizeKeyName(e))||e.ctrlKey||e.metaKey},_maskBackspaceHandler:function(e){var t=this;t._keyPressHandled=!0;var a=function(e,a){e&&(t._direction("forward"),t._adjustCaret());var s=t._caret();clearTimeout(t._backspaceHandlerTimeout),t._backspaceHandlerTimeout=setTimeout((function(){a(s)}))};t._maskKeyHandler(e,(function(){t._hasSelection()?a(!0,(function(e){t._displayMask(e),t._maskRulesChain.reset()})):t._tryMoveCaretBackward()?a(!1,(function(e){t._caret(e)})):(t._handleKey(" ","backward"),a(!0,(function(e){t._displayMask(e),t._maskRulesChain.reset()})))}))},_maskDelHandler:function(e){this._keyPressHandled=!0,this._maskKeyHandler(e,(function(){return!this._hasSelection()&&this._handleKey(" "),!0}))},_maskPasteHandler:function(e){this._keyPressHandled=!0;var t=this._caret();this._maskKeyHandler(e,(function(){var a=n.clipboardText(e),s=this._maskRulesChain.text().substring(t.end),i=this._handleChain({text:a,start:t.start,length:a.length}),r=t.start+i;return this._handleChain({text:s,start:r,length:s.length}),this._caret({start:r,end:r}),!0}))},_handleChain:function(e){var t=this._maskRulesChain.handle(this._normalizeChainArguments(e));return this._value=this._maskRulesChain.value(),this._textValue=this._maskRulesChain.text(),t},_normalizeChainArguments:function(e){return(e=e||{}).index=0,e.fullText=this._maskRulesChain.text(),e},_maskCutHandler:function(e){var t=this._caret(),a=this._input().val().substring(t.start,t.end);this._maskKeyHandler(e,(function(){return n.clipboardText(e,a),!0}))},_maskDragHandler:function(){this._clearDragTimer(),this._dragTimer=setTimeout(function(){this.option("value",this._convertToValue(this._input().val()))}.bind(this))},_convertToValue:function(e){return e=this._isMaskedValueMode()?(e||this._textValue||"").replace(new RegExp(this.option("maskChar"),"g")," "):e||this._value||""},_maskKeyHandler:function(e,t){this.option("readOnly")||(this._direction("forward"),e.preventDefault(),this._handleSelection(),t.call(this)&&(this._direction("forward"),this._adjustCaret(),this._displayMask(),this._maskRulesChain.reset()))},_handleKey:function(e,t){this._direction(t||"forward"),this._adjustCaret(e),this._handleKeyChain(e),this._moveCaret()},_handleSelection:function(){if(this._hasSelection()){var e=this._caret(),t=new Array(e.end-e.start+1).join(" ");this._handleKeyChain(t)}},_handleKeyChain:function(e){var t=this._caret(),a=this._isForwardDirection()?t.start:t.start-1,s=this._isForwardDirection()?t.end:t.end-1,i=a===s?1:s-a;this._handleChain({text:e,start:a,length:i})},_tryMoveCaretBackward:function(){this._direction("backward");var e=this._caret().start;return this._adjustCaret(),!e||e!==this._caret().start},_adjustCaret:function(e){var t=this._maskRulesChain.adjustedCaret(this._caret().start,this._isForwardDirection(),e);this._caret({start:t,end:t})},_moveCaret:function(){var e=this._caret().start,t=e+(this._isForwardDirection()?0:-1),a=this._maskRulesChain.isAccepted(t)?e+(this._isForwardDirection()?1:-1):e;this._caret({start:a,end:a})},_caret:function(e){var t=this._input();if(t.length)return arguments.length?void i(t,e):i(t)},_hasSelection:function(){var e=this._caret();return e.start!==e.end},_direction:function(e){if(!arguments.length)return this._typingDirection;this._typingDirection=e},_isForwardDirection:function(){return"forward"===this._direction()},_clearDragTimer:function(){clearTimeout(this._dragTimer)},_clean:function(){this._clearDragTimer(),this.callBase()},_validateMask:function(){if(this._maskRulesChain){var e=m.isEmpty(this.option("value"))||this._maskRulesChain.isValid(this._normalizeChainArguments());this.option({isValid:e,validationError:e?null:{editorSpecific:!0,message:this.option("maskInvalidMessage")}})}},_dispose:function(){clearTimeout(this._inputHandlerTimer),clearTimeout(this._backspaceHandlerTimeout),clearTimeout(this._caretTimeout),this.callBase()},_updateHiddenElement:function(){this._removeHiddenElement(),this.option("mask")&&(this._input().removeAttr("name"),this._renderHiddenElement()),this._setSubmitElementName(this.option("name"))},_updateMaskOption:function(){this._updateHiddenElement(),this._renderMask(),this._validateMask()},_processEmptyMask:function(e){if(!e){var t=this.option("value");this.option({text:t,isValid:!0}),this.validationRequest.fire({value:t,editor:this}),this._renderValue()}},_optionChanged:function(e){switch(e.name){case"mask":this._updateMaskOption(),this._processEmptyMask(e.value);break;case"maskChar":case"maskRules":case"useMaskedValue":this._updateMaskOption();break;case"value":this._renderMaskedValue(),this._validateMask(),this.callBase(e);break;case"maskInvalidMessage":break;case"showMaskMode":this.option("text",""),this._renderValue();break;default:this.callBase(e)}}});a.exports=D}

