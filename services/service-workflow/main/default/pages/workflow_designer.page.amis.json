{
    "type": "page",
    "title": "Welcome to Steedos",
    "body": [
        {
            "type": "service",
            "id": "service_react_flow",
            "body": [
                {
                    "type": "panel",
                    "body": [
                        {
                            "type": "panel",
                            "body": [
                                {
                                    "type": "tabs",
                                    "id": "tabs_react_flow",
                                    "tabs": [
                                        {
                                            "title": "流程信息",
                                            "tab": [
                                                {
                                                    "type": "form",
                                                    "wrapWithPanel": false,
                                                    "body": [
                                                        {
                                                            "label": "流程名称",
                                                            "type": "input-text",
                                                            "name": "flow.name",
                                                            "id": "u:ded33d6cc55e"
                                                        },
                                                        {
                                                            "label": "流程描述",
                                                            "type": "input-text",
                                                            "name": "flow.description",
                                                            "id": "u:72318c2f6664"
                                                        },
                                                        {
                                                            "label": "创建时间",
                                                            "type": "input-text",
                                                            "name": "_display.created",
                                                            "static": true,
                                                            "id": "u:a0ad60dadeb1"
                                                        },
                                                        {
                                                            "label": "创建人",
                                                            "type": "input-text",
                                                            "name": "_display.created_by.label",
                                                            "static": true,
                                                            "id": "u:80a8e4172436"
                                                        }
                                                    ],
                                                    "id": "u:505aed37e326",
                                                    "debug": false,
                                                    "onEvent": {
                                                        "change": {
                                                            "weight": 0,
                                                            "actions": [
                                                                {
                                                                    "componentId": "service_react_flow",
                                                                    "actionType": "setValue",
                                                                    "args": {
                                                                        "value": {
                                                                            "flow.name": "${flow.name}",
                                                                            "flow.description": "${flow.description}"
                                                                        }
                                                                    }
                                                                }
                                                            ]
                                                        }
                                                    }
                                                }
                                            ],
                                            "id": "u:bbe62967461e",
                                            "className": "px-0"
                                        },
                                        {
                                            "title": "画图",
                                            "tab": [
                                                {
                                                    "$ref": "buttonAddStep",
                                                    "label": "审批",
                                                    "stepProps": {
                                                        "name": "审批",
                                                        "step_type": "sign"
                                                    },
                                                    "id": "u:e02e02910f9e"
                                                },
                                                {
                                                    "$ref": "buttonAddStep",
                                                    "label": "会签",
                                                    "stepProps": {
                                                        "name": "会签",
                                                        "step_type": "counterSign"
                                                    },
                                                    "id": "u:3d55a6911d13"
                                                },
                                                {
                                                    "$ref": "buttonAddStep",
                                                    "label": "填写",
                                                    "stepProps": {
                                                        "name": "填写",
                                                        "step_type": "submit"
                                                    },
                                                    "id": "u:1dc1bcb7f401"
                                                },
                                                {
                                                    "$ref": "buttonAddStep",
                                                    "label": "条件",
                                                    "stepProps": {
                                                        "name": "条件",
                                                        "step_type": "condition"
                                                    },
                                                    "id": "u:9a7cf380d1fa"
                                                }
                                            ],
                                            "id": "u:64e15bf9f638",
                                            "className": "px-0"
                                        },
                                        {
                                            "title": "属性",
                                            "tab": [
                                                {
                                                    "type": "each",
                                                    "id": "u:de445fd7654a",
                                                    "items": {
                                                        "type": "form",
                                                        "debug": true,
                                                        "body": [
                                                            {
                                                                "type": "input-text",
                                                                "name": "data.name",
                                                                "label": "步骤名称",
                                                                "id": "u:561792782229"
                                                            },
                                                            {
                                                                "type": "input-text",
                                                                "name": "data.description",
                                                                "label": "描述",
                                                                "id": "u:ace132578700"
                                                            }
                                                        ],
                                                        "wrapWithPanel": false,
                                                        "id": "u:0e484d5ffbf5",
                                                        "onEvent": {
                                                            "change": {
                                                                "weight": 0,
                                                                "actions": [
                                                                    {
                                                                        "actionType": "custom",
                                                                        "script": "event.data.reactFlowInstance.setNodes(function (nds) {\n  return nds.map((node) => {\n    if (node.id === event.data.id) {\n      node.data = {\n        ...node.data,\n        ...event.data.data,\n      };\n      node.data.label = Steedos.getWorkflowStepLabel(node.data);\n    }\n    return node;\n  })\n});"
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    },
                                                    "source": "${reactFlowSelection.nodes}",
                                                    "visibleOn": "${reactFlowSelection.nodes.length}"
                                                },
                                                {
                                                    "type": "each",
                                                    "items": {
                                                        "type": "form",
                                                        "debug": true,
                                                        "body": [
                                                            {
                                                                "type": "input-text",
                                                                "name": "data.name",
                                                                "label": "连线名称",
                                                                "id": "u:3de37a96b91a"
                                                            },
                                                            {
                                                                "type": "checkbox",
                                                                "name": "data.timeout_line",
                                                                "label": "超时设置",
                                                                "id": "u:f0fc5232275c",
                                                                "option": "超时自动流转到此路径"
                                                            }
                                                        ],
                                                        "wrapWithPanel": false,
                                                        "id": "u:6767d57a2ec1",
                                                        "onEvent": {
                                                            "change": {
                                                                "weight": 0,
                                                                "actions": [
                                                                    {
                                                                        "actionType": "custom",
                                                                        "script": "debugger;\nevent.data.reactFlowInstance.setEdges(function (eds) {\n  return eds.map((edge) => {\n    if (edge.id === event.data.id) {\n      edge.data = {\n        ...edge.data,\n        ...event.data.data,\n      };\n      edge.label = edge.data.name;\n    }\n    return edge;\n  })\n});"
                                                                    }
                                                                ]
                                                            }
                                                        }
                                                    },
                                                    "id": "u:d835e9606d64",
                                                    "source": "${reactFlowSelection.edges}",
                                                    "visibleOn": "${reactFlowSelection.edges.length}"
                                                }
                                            ],
                                            "id": "u:406e84d38bbe",
                                            "className": "px-0"
                                        }
                                    ],
                                    "contentClassName": "bg-gray-50"
                                }
                            ],
                            "id": "u:a585ef75560b",
                            "className": "absolute top-0 right-0 bottom-0 w-80 z-10 m-0 rounded-none overflow-auto bg-gray-50 border-none border-left",
                            "title": "",
                            "affixFooter": false
                        },
                        {
                            "type": "steedos-react-flow",
                            "id": "u:4dc36cb794c7",
                            "onEvent": {
                                "getInstance": {
                                    "weight": 0,
                                    "actions": [
                                        {
                                            "actionType": "setValue",
                                            "args": {
                                                "value": {
                                                    "reactFlowInstance": "${event.data.reactFlowInstance}"
                                                }
                                            },
                                            "componentId": "service_react_flow"
                                        }
                                    ]
                                },
                                "selectionChange": {
                                    "weight": 0,
                                    "actions": [
                                        {
                                            "actionType": "setValue",
                                            "args": {
                                                "value": {
                                                    "reactFlowSelection": "${event.data}"
                                                }
                                            },
                                            "componentId": "service_react_flow"
                                        },
                                        {
                                            "actionType": "changeActiveKey",
                                            "args": {
                                                "activeKey": 3
                                            },
                                            "componentId": "tabs_react_flow",
                                            "expression": "${event.data.nodes.length || event.data.edges.length}"
                                        },
                                        {
                                            "actionType": "changeActiveKey",
                                            "args": {
                                                "activeKey": 1
                                            },
                                            "componentId": "tabs_react_flow",
                                            "expression": "${event.data.nodes.length === 0 && event.data.edges.length === 0}"
                                        }
                                    ]
                                }
                            },
                            "name": "flow_chart",
                            "wrapperClassName": "absolute top-0 right-80 bottom-0 left-0",
                            "config": "${config}",
                            "visibleOn": "${config.nodes.length}",
                            "backgroundConfig": {
                                "variant": "lines"
                            }
                        }
                    ],
                    "id": "u:eeee71a41b86",
                    "affixFooter": false,
                    "className": "Panel--default h-full warpper-panel bg-white",
                    "bodyClassName": "warpper-panel-body relative",
                    "header": [
                        {
                            "type": "tpl",
                            "id": "u:b2ad0b257ab1",
                            "className": "flex flex-1 justify-center",
                            "tpl": "${flow.name}"
                        },
                        {
                            "type": "button",
                            "label": "保存",
                            "id": "u:6609db3e32cf",
                            "className": "mr-3",
                            "onEvent": {
                                "click": {
                                    "weight": 0,
                                    "actions": [
                                        {
                                            "actionType": "custom",
                                            "script": "debugger;\n\n// 根据reactFlowData.nodes,reactFlowData.edges生成需要保存的步骤集合，连线在步骤里面\nfunction getStepsForSave(nodes, edges) {\n  // 参考老流程设计器代码，补充必要的属性规则\n  // https://github.com/steedos/steedos-web \n  return [];\n}\n\nvar reactFlowInstance = event.data.reactFlowInstance;\nvar reactFlowData = reactFlowInstance && reactFlowInstance.toObject();\nvar steps = getStepsForSave(reactFlowData.nodes, reactFlowData.edges);\nvar flow = event.data.flow;\ndelete flow._display;\ndelete flow.form__expand;\nevent.data.flowsForSave = [{\n  ...flow,\n  current: {\n    ...flow.current,\n    steps\n  }\n}]\n"
                                        },
                                        {
                                            "actionType": "ajax",
                                            "outputVar": "responseResult",
                                            "args": {
                                                "options": {},
                                                "api": {
                                                    "url": "/testSaveFlow",
                                                    "method": "post",
                                                    "requestAdaptor": "",
                                                    "adaptor": "",
                                                    "messages": {},
                                                    "data": {
                                                        "Flows": "${flowsForSave}"
                                                    }
                                                }
                                            }
                                        }
                                    ]
                                }
                            }
                        }
                    ],
                    "headerClassName": "flex justify-between items-center h-12 border-bottom bg-gray-50 rounded-t-md",
                    "title": "",
                    "actions": []
                }
            ],
            "className": "w-full h-full",
            "messages": {},
            "api": {
                "url": "/graphql",
                "method": "post",
                "messages": {},
                "requestAdaptor": "const flowId = api.data.flowId;\napi.data.query = `\n    {\n        data: flows(filters: [\"_id\", \"=\", \"`+ flowId +`\"]){\n            _id, name, category, form, current, description\n            created, created_by, modified, modified_by,\n            form__expand{\n                name,\n                current\n            },\n            _display:_ui{ created,created_by,modified,modified_by }\n        }\n    }\n`;\nreturn api;\n\n",
                "adaptor": "const data = payload.data.data && payload.data.data[0];\nlet convertedNodes = [];\nlet convertedEdges = [];\n\n\nif (data && data.current && data.current.steps && data.current.steps.length) {\n  data.current.steps.forEach(function (step) {\n    var type;\n    if (step.step_type == \"start\") {\n      // 开始结点有可能作为连线的终点\n      // type = \"input\";\n    }\n    else if (step.step_type == \"end\") {\n      type = \"output\";\n    }\n    convertedNodes.push({\n      id: step._id,\n      type: type,\n      position: {\n        x: step.posx,\n        y: step.posy\n      },\n      sourcePosition: \"right\",\n      targetPosition: \"left\",\n      data: {\n        label: Steedos.getWorkflowStepLabel(step),\n        ...step\n      }\n    });\n    if (step.lines) {\n      step.lines.forEach(function (line) {\n        convertedEdges.push({\n          id: line._id || Steedos.getWorkflowUUID(),\n          label: line.name,\n          source: step._id,\n          target: line.to_step,\n          markerEnd: {\n            type: \"arrowclosed\",\n            width: 20,\n            height: 20,\n            // color: '#999',\n          },\n          style: {\n            // stroke: \"#999\",\n            strokeWidth: 1\n          },\n          labelStyle: {\n            fontSize: \"15px\"\n          },\n          data: {\n            ...line\n          }\n        });\n      });\n    }\n  });\n}\nlet convertedConfigData = {\n  nodes: convertedNodes,\n  edges: convertedEdges\n};\nreturn {\n  \"status\": 0,\n  \"msg\": \"\",\n  \"data\": {\n    \"flow\": {\n      ...data,\n    },\n    \"config\": convertedConfigData\n  }\n}",
                "dataType": "json"
            },
            "data__": {
                "config": {
                    "edges": [
                        {
                            "id": "start-end",
                            "source": "start",
                            "target": "end",
                            "label": ""
                        }
                    ],
                    "nodes": [
                        {
                            "id": "start",
                            "data": {
                                "label": "开始",
                                "name": "开始",
                                "step_type": "start",
                                "timeout_hours": 168
                            },
                            "position": {
                                "x": 20,
                                "y": 20
                            },
                            "type": "input"
                        },
                        {
                            "id": "end",
                            "data": {
                                "label": "结束",
                                "name": "结束",
                                "step_type": "end"
                            },
                            "position": {
                                "x": 200,
                                "y": 200
                            }
                        }
                    ]
                }
            }
        }
    ],
    "regions": [
        "body"
    ],
    "data": {
        "initialValues": {},
        "appId": "builder",
        "title": "",
        "context": {
            "rootUrl": "http://127.0.0.1:5800",
            "tenantId": "64a4d6dd7fe9acaf8c330a37",
            "userId": "683e09cd-8482-4034-bd29-5a30643e6c0f",
            "authToken": "70c5ca01144799fd8a777223bff1b3bc1860c541b4d8eda9e6b215875e43a15949f266f1cb7de7a2e699f2"
        }
    },
    "id": "u:95b021ef4426",
    "definitions": {
        "buttonAddStep": {
            "type": "button",
            "label": "审批",
            "level": "primary",
            "onEvent": {
                "click": {
                    "actions": [
                        {
                            "actionType": "custom",
                            "script": "var id = Steedos.getWorkflowUUID();\nvar stepProps = context.props.stepProps;\n\nvar newNode = {\n  id,\n  position: {\n    x: Math.random() * 500,\n    y: Math.random() * 500,\n  },\n  data: {\n    ...stepProps,\n    label: Steedos.getWorkflowStepLabel(stepProps)\n  },\n  sourcePosition: \"right\",\n  targetPosition: \"left\",\n  width: 100,\n  height: 41\n};\nvar reactFlowInstance = event.data.reactFlowInstance;\nreactFlowInstance?.addNodes([newNode]);"
                        }
                    ]
                }
            }
        }
    },
    "className": "workflow-designer-page"
}